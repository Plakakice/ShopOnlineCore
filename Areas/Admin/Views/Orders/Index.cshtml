@model List<ShopOnlineCore.Models.Order>
@{
    ViewData["Title"] = "Quản trị đơn hàng";
    var allowedStatuses = (string[])ViewData["AllowedStatuses"]!;
    string? status = ViewData["StatusFilter"] as string;
    string? q = ViewData["Query"] as string;
    string? from = ViewData["From"] as string;
    string? to = ViewData["To"] as string;
    int pageNumber = (int)(ViewData["Page"] ?? 1);
    int pageSize = (int)(ViewData["PageSize"] ?? 20);
    int totalCount = (int)(ViewData["TotalCount"] ?? Model.Count);
    int totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
}

<!-- Page Header -->
<div class="page-head_agile_info_w3l">
    <div class="container">
        <h3>Quản trị <span>Đơn hàng</span></h3>
        <div class="services-breadcrumb">
            <div class="agile_inner_breadcrumb">
                <ul class="w3_short">
                    <li><a asp-controller="Home" asp-action="Index">Trang chủ</a><i>|</i></li>
                    <li>Admin</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Content Wrapper theo style trang Single -->
<div class="banner-bootom-w3-agileits">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="card" style="border:none; box-shadow:0 1px 3px rgba(0,0,0,.1);">
                    <div class="card-body">
                        <form method="get" class="row g-2 align-items-end mb-3">
                            <div class="col-md-2">
                                <label class="form-label">Trạng thái</label>
                                <select class="form-control" name="status">
                                    <option value="">-- Tất cả --</option>
                                    @foreach (var s in allowedStatuses)
                                    {
                                        <option value="@s" selected="@(s == status)">@s</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Tìm kiếm</label>
                                <input class="form-control" name="q" value="@q" placeholder="Tên, Email hoặc Mã đơn" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Từ ngày</label>
                                <input type="date" class="form-control" name="from" value="@from" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Đến ngày</label>
                                <input type="date" class="form-control" name="to" value="@to" />
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">Trang</label>
                                <input type="number" class="form-control" name="page" value="@pageNumber" min="1" max="@Math.Max(totalPages,1)" />
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">/trang</label>
                                <input type="number" class="form-control" name="pageSize" value="@pageSize" min="5" max="100" />
                            </div>
                            <div class="col-md-2 text-end">
                                <button type="submit" class="btn btn-primary w-100">Lọc</button>
                            </div>
                        </form>

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover align-middle" style="background:#fff;">
                                <thead style="background:#f8f9fa;">
                                    <tr>
                                        <th>Mã</th>
                                        <th>Khách hàng</th>
                                        <th>Email</th>
                                        <th>Ngày tạo</th>
                                        <th>SL mặt hàng</th>
                                        <th>Tổng tiền</th>
                                        <th>Trạng thái</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                @foreach (var o in Model)
                                {
                                    <tr>
                                        <td><strong>#@o.Id</strong></td>
                                        <td>@o.CustomerName</td>
                                        <td>@o.Email</td>
                                        <td>@o.CreatedDate.ToString("yyyy-MM-dd HH:mm")</td>
                                        <td class="text-center">@o.OrderItems.Count</td>
                                        <td class="text-end"><strong>@o.Total.ToString("N0") ₫</strong></td>
                                        <td>
                                            @{
                                                var badgeClass = o.Status switch
                                                {
                                                    "Pending" => "badge bg-warning text-dark",
                                                    "Processing" => "badge bg-info text-white",
                                                    "Shipped" => "badge bg-primary",
                                                    "Delivered" => "badge bg-success",
                                                    "Cancelled" => "badge bg-danger",
                                                    _ => "badge bg-secondary"
                                                };
                                            }
                                            <span class="@badgeClass">@o.Status</span>
                                        </td>
                                        <td class="text-end">
                                            <a class="btn btn-sm btn-outline-primary" asp-area="Admin" asp-controller="Orders" asp-action="Details" asp-route-id="@o.Id"><i class="fa fa-eye"></i> Chi tiết</a>
                                        </td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>

                        @if (totalPages > 1)
                        {
                            <nav>
                                <ul class="pagination">
                                    <li class="page-item @(pageNumber == 1 ? "disabled" : "")">
                                        <a class="page-link" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="@status" asp-route-q="@q" asp-route-from="@from" asp-route-to="@to" asp-route-page="@(pageNumber-1)" asp-route-pageSize="@pageSize">«</a>
                                    </li>
                                    @for (var p = 1; p <= totalPages; p++)
                                    {
                                        <li class="page-item @(p == pageNumber ? "active" : "")">
                                            <a class="page-link" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="@status" asp-route-q="@q" asp-route-from="@from" asp-route-to="@to" asp-route-page="@p" asp-route-pageSize="@pageSize">@p</a>
                                        </li>
                                    }
                                    <li class="page-item @(pageNumber == totalPages ? "disabled" : "")">
                                        <a class="page-link" asp-area="Admin" asp-controller="Orders" asp-action="Index" asp-route-status="@status" asp-route-q="@q" asp-route-from="@from" asp-route-to="@to" asp-route-page="@(pageNumber+1)" asp-route-pageSize="@pageSize">»</a>
                                    </li>
                                </ul>
                            </nav>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
