@model IEnumerable<ShopOnlineCore.Models.Product>
@{
    ViewData["Title"] = "Qu·∫£n l√Ω s·∫£n ph·∫©m";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var totalCount = (int)(ViewData["TotalCount"] ?? 0);
    var page = (int)(ViewData["Page"] ?? 1);
    var pageSize = (int)(ViewData["PageSize"] ?? 20);
    var totalPages = (int)(ViewData["TotalPages"] ?? 1);
    var search = ViewData["Search"]?.ToString() ?? "";
    var category = ViewData["Category"]?.ToString() ?? "";

    var totalProducts = (int)(ViewData["TotalProducts"] ?? 0);
    var totalInStock = (int)(ViewData["TotalInStock"] ?? 0);
    var totalOutOfStock = (int)(ViewData["TotalOutOfStock"] ?? 0);
    var totalValue = (decimal)(ViewData["TotalValue"] ?? 0);
}

<style>
    .admin-header {
        background: linear-gradient(135deg, #2fdab8 0%, #27b39e 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
        border-radius: 0;
    }

    .stats-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border-left: 4px solid;
    }

    .stats-card h3 {
        margin: 0;
        color: #333;
        font-size: 1.8em;
        font-weight: 700;
    }

    .stats-card p {
        margin: 8px 0 0 0;
        color: #999;
        font-size: 0.9em;
    }

    .filter-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 30px;
    }

    .filter-card label {
        font-weight: 600;
        color: #333;
        font-size: 0.95em;
        margin-bottom: 8px;
    }

    .filter-card .form-control,
    .filter-card .form-select {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px 12px;
        transition: all 0.3s ease;
    }

    .filter-card .form-control:focus,
    .filter-card .form-select:focus {
        border-color: #2fdab8;
        box-shadow: 0 0 0 3px rgba(47, 218, 184, 0.1);
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .action-buttons .btn {
        border-radius: 6px;
        font-weight: 600;
        padding: 10px 16px;
        transition: all 0.3s ease;
    }

    .action-buttons .btn-success {
        background: #27ae60;
        border: none;
    }

    .action-buttons .btn-success:hover {
        background: #229954;
    }

    .table-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .table-card table {
        margin-bottom: 0;
    }

    .table-card thead {
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
    }

    .table-card thead th {
        font-weight: 700;
        color: #333;
        padding: 16px;
        border: none;
        font-size: 0.95em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table-card tbody td {
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
        color: #555;
        vertical-align: middle;
    }

    .table-card tbody tr:hover {
        background-color: #f9f9f9;
    }

    .product-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 6px;
    }

    .product-id {
        font-weight: 700;
        color: #2fdab8;
    }

    .product-price {
        font-weight: 700;
        color: #e74c3c;
        font-size: 1.05em;
    }

    .badge-custom {
        padding: 8px 12px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85em;
    }

    .badge-available {
        background: #d4edda;
        color: #155724;
    }

    .badge-unavailable {
        background: #f8d7da;
        color: #721c24;
    }

    .action-buttons-row {
        display: flex;
        gap: 6px;
    }

    .action-buttons-row .btn {
        padding: 6px 10px;
        font-size: 0.85em;
        border-radius: 4px;
        border: none;
        transition: all 0.3s ease;
    }

    .btn-edit {
        background: #3498db;
        color: white;
    }

    .btn-edit:hover {
        background: #2980b9;
    }

    .btn-view {
        background: #27ae60;
        color: white;
    }

    .btn-view:hover {
        background: #229954;
    }

    .btn-delete {
        background: #e74c3c;
        color: white;
    }

    .btn-delete:hover {
        background: #c0392b;
    }

    .pagination {
        justify-content: center;
        margin-top: 30px;
    }

    .pagination .page-link {
        border: 1px solid #ddd;
        color: #2fdab8;
        border-radius: 6px;
        margin: 0 4px;
        transition: all 0.3s ease;
    }

    .pagination .page-link:hover {
        background-color: #2fdab8;
        border-color: #2fdab8;
        color: white;
    }

    .pagination .page-item.active .page-link {
        background-color: #2fdab8;
        border-color: #2fdab8;
    }
</style>

<!-- Page Header -->
<div class="admin-header">
    <div class="container-fluid" style="padding: 0 10px;">
        <h2 style="margin: 0; font-size: 2em; font-weight: 700;">üì¶ Qu·∫£n tr·ªã S·∫£n ph·∫©m</h2>
        <p style="margin: 5px 0 0 0; opacity: 0.95;">Qu·∫£n l√Ω danh s√°ch s·∫£n ph·∫©m c·ªßa c·ª≠a h√†ng</p>
    </div>
</div>

<!-- Content -->
<div class="container-fluid" style="margin-bottom: 50px; padding: 0 10px;">
    
    <!-- Statistics Cards -->
    <div class="row mb-4" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div class="stats-card" style="border-left-color: #2fdab8;">
            <p>T·ªïng s·∫£n ph·∫©m</p>
            <h3>@totalProducts</h3>
        </div>
        <div class="stats-card" style="border-left-color: #27ae60;">
            <p>C√≤n h√†ng</p>
            <h3>@totalInStock</h3>
        </div>
        <div class="stats-card" style="border-left-color: #e74c3c;">
            <p>H·∫øt h√†ng</p>
            <h3>@totalOutOfStock</h3>
        </div>
        <div class="stats-card" style="border-left-color: #f39c12;">
            <p>Gi√° tr·ªã kho</p>
            <h3 style="font-size: 1.4em;">@totalValue.ToString("N0")‚Ç´</h3>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="filter-card">
        <div class="action-buttons">
            <a href="@Url.Action("Create", "Product", new { area = "" })" class="btn btn-success">
                <i class="fa fa-plus"></i> Th√™m s·∫£n ph·∫©m
            </a>
            <button type="button" class="btn btn-danger" onclick="bulkDelete()" style="background: #e74c3c; border: none;">
                <i class="fa fa-trash"></i> X√≥a ƒë√£ ch·ªçn
            </button>
            <button type="button" class="btn btn-warning" onclick="showBulkPriceModal()" style="background: #f39c12; border: none;">
                <i class="fa fa-tags"></i> Sale h√†ng lo·∫°t
            </button>
            <a href="@Url.Action("Index", "Categories", new { area = "Admin" })" class="btn btn-info" style="background: #3498db; border: none; color: white;">
                <i class="fa fa-list"></i> Qu·∫£n l√Ω danh m·ª•c
            </a>
        </div>

        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Danh m·ª•c</label>
                <select class="form-select" name="category" onchange="this.form.submit()">
                    <option value="">-- T·∫•t c·∫£ danh m·ª•c --</option>
                    @if (ViewBag.Categories != null)
                    {
                        foreach (var cat in ViewBag.Categories as List<ShopOnlineCore.Models.Category>)
                        {
                            <option value="@cat.Name" selected="@(category == cat.Name)">@cat.Name</option>
                        }
                    }
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">T√¨m ki·∫øm</label>
                <input type="search" name="search" value="@search" class="form-control" placeholder="T√™n s·∫£n ph·∫©m..." />
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100" style="background: linear-gradient(135deg, #2fdab8 0%, #27b39e 100%); border: none; padding: 10px; font-weight: 600; height: 38px;">
                    <i class="fa fa-search"></i> T√¨m
                </button>
            </div>
        </form>
    </div>

    <!-- Table Card -->
    <div class="table-card">
        <div style="overflow-x: auto;">
            <table class="table table-hover" style="margin-bottom: 0;">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                        <th style="width: 60px; ">ID</th>
                        <th style="width: 80px; ">·∫¢nh</th>
                        <th style="width: 200px;">T√™n s·∫£n ph·∫©m</th>
                        <th style="width: 80px; text-align: center;">Danh m·ª•c</th>
                        <th style="width: 100px; ">Gi√°</th>
                        <th style="width: 80px; text-align: center;">Kho</th>
                        <th style="width: 110px; text-align: center;">Tr·∫°ng th√°i</th>
                        <th style="width: 140px; ">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Any())
                    {
                        @foreach (var product in Model)
                        {
                            <tr>
                                <td><input type="checkbox" class="product-checkbox" value="@product.Id"></td>
                                <td><span class="product-id">#@product.Id</span></td>
                                <td>
                                    <img src="@Url.Content(product.ImageUrl)" alt="@product.Name" class="product-img">
                                </td>
                                <td>
                                    <strong style="color: #333;">@product.Name</strong><br>
                                    @{
                                        var desc = product.Description ?? "";
                                        var shortDesc = desc.Length > 50 ? desc.Substring(0, 50) + "..." : desc;
                                    }
                                    <small style="color: #999;">@shortDesc</small>
                                </td>
                                <td>
                                    <span class="badge-custom" style="background: #e8f9f6; color: #2fdab8; font-weight: 600;">@product.Category</span>
                                </td>
                                <td>
                                    <span class="product-price">@product.Price.ToString("N0")‚Ç´</span>
                                </td>
                                <td style="text-align: center;">
                                    <input type="number" class="form-control form-control-sm" 
                                           value="@product.Stock" min="0" 
                                           onchange="updateStock(@product.Id, this.value)"
                                           style="width: 70px; margin: 0 auto; text-align: center;">
                                </td>
                                <td>
                                    @if (product.IsAvailable)
                                    {
                                        <span class="badge-custom badge-available">C√≤n h√†ng</span>
                                    }
                                    else
                                    {
                                        <span class="badge-custom badge-unavailable">H·∫øt h√†ng</span>
                                    }
                                </td>
                                <td style="text-align: center;">
                                    <div class="action-buttons-row">
                                        <a href="@Url.Action("Edit", "Product", new { area = "", id = product.Id })" class="btn btn-edit" title="S·ª≠a">
                                            <i class="fa fa-edit"></i>
                                        </a>
                                        <a href="@Url.Action("Details", "Product", new { area = "", id = product.Id })" class="btn btn-view" title="Xem">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                        <button onclick="deleteProduct(@product.Id)" class="btn btn-delete" title="X√≥a">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #999;">
                                <i class="fa fa-inbox" style="font-size: 2em; margin-bottom: 15px; display: block;"></i>
                                Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <nav style="padding: 25px;">
                <ul class="pagination">
                    <li class="page-item @(page == 1 ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { page = page > 1 ? page - 1 : 1, search, category })">
                            <i class="fa fa-chevron-left"></i> Tr∆∞·ªõc
                        </a>
                    </li>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == page ? "active" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = i, search, category })">@i</a>
                        </li>
                    }
                    <li class="page-item @(page == totalPages ? "disabled" : "")">
                        <a class="page-link" href="@Url.Action("Index", new { page = page < totalPages ? page + 1 : totalPages, search, category })">
                            Sau <i class="fa fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
                <p style="text-align: center; color: #999; margin-top: 15px; font-size: 0.9em;">Hi·ªÉn th·ªã @Model.Count() / @totalCount s·∫£n ph·∫©m</p>
            </nav>
        }
    </div>
</div>

<!-- Modal c·∫≠p nh·∫≠t gi√° h√†ng lo·∫°t -->
<div class="modal fade" id="bulkPriceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sale h√†ng lo·∫°t</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group" id="percentageGroup">
                    <label>Ph·∫ßn trƒÉm thay ƒë·ªïi (%)</label>
                    <input type="number" id="pricePercentage" class="form-control" value="10" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>H√†nh ƒë·ªông</label>
                    <select id="priceAction" class="form-control" onchange="togglePercentageInput()">
                        <option value="decrease">Gi·∫£m gi√°</option>
                        <option value="increase">TƒÉng gi√°</option>
                        <option value="end_sale">H·∫øt gi·∫£m gi√° (V·ªÅ gi√° g·ªëc)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="bulkUpdatePrice()">C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle select all
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = checked);
        }

        // C·∫≠p nh·∫≠t stock nhanh
        function updateStock(id, stock) {
            fetch('@Url.Action("UpdateStock")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': '@Html.AntiForgeryToken()'
                },
                body: `id=${id}&stock=${stock}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    setTimeout(() => location.reload(), 500);
                } else {
                    showToast('error', data.message);
                }
            });
        }

        // X√≥a s·∫£n ph·∫©m ƒë∆°n
        function deleteProduct(id) {
            if (!confirm('X√°c nh·∫≠n x√≥a s·∫£n ph·∫©m n√†y?')) return;
            
            fetch('@Url.Action("BulkDelete")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `ids=${id}`
            })
            .then(res => res.json())
            .then(data => {
                showToast(data.success ? 'success' : 'error', data.message);
                if (data.success) setTimeout(() => location.reload(), 500);
            });
        }

        // X√≥a nhi·ªÅu s·∫£n ph·∫©m
        function bulkDelete() {
            const ids = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            if (ids.length === 0) {
                showToast('warning', 'Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o');
                return;
            }
            if (!confirm(`X√°c nh·∫≠n x√≥a ${ids.length} s·∫£n ph·∫©m ƒë√£ ch·ªçn?`)) return;

            fetch('@Url.Action("BulkDelete")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `ids=${ids.join('&ids=')}`
            })
            .then(res => res.json())
            .then(data => {
                showToast(data.success ? 'success' : 'error', data.message);
                if (data.success) setTimeout(() => location.reload(), 1000);
            });
        }

        // Hi·ªÉn th·ªã modal c·∫≠p nh·∫≠t gi√°
        function showBulkPriceModal() {
            const ids = Array.from(document.querySelectorAll('.product-checkbox:checked'));
            if (ids.length === 0) {
                showToast('warning', 'Ch∆∞a ch·ªçn s·∫£n ph·∫©m n√†o');
                return;
            }
            $('#bulkPriceModal').modal('show');
            togglePercentageInput(); // Reset UI state
        }

        function togglePercentageInput() {
            const action = document.getElementById('priceAction').value;
            const group = document.getElementById('percentageGroup');
            if (action === 'end_sale') {
                group.style.display = 'none';
            } else {
                group.style.display = 'block';
            }
        }

        // C·∫≠p nh·∫≠t gi√° h√†ng lo·∫°t
        function bulkUpdatePrice() {
            const ids = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            const percentage = document.getElementById('pricePercentage').value;
            const action = document.getElementById('priceAction').value;

            fetch('@Url.Action("BulkUpdatePrice")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `ids=${ids.join('&ids=')}&percentage=${percentage}&action=${action}`
            })
            .then(res => res.json())
            .then(data => {
                $('#bulkPriceModal').modal('hide');
                showToast(data.success ? 'success' : 'error', data.message);
                if (data.success) setTimeout(() => location.reload(), 1000);
            });
        }

        // Toast notification
        function showToast(type, message) {
            const colors = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12'
            };
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top: 80px; right: 20px; background: ${colors[type]}; color: white; padding: 15px 20px; border-radius: 5px; z-index: 9999; box-shadow: 0 4px 8px rgba(0,0,0,0.2);`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
}
