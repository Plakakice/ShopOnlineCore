@model IEnumerable<ShopOnlineCore.Models.Product>
@{
    ViewData["Title"] = "Trang chủ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Carousel full-width */
    #myCarousel {
        width: 100vw !important;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        margin-bottom: 0 !important;
    }
    
    #myCarousel .carousel-inner {
        width: 100vw;
    }
    
    #myCarousel .item {
        width: 100vw;
        height: 500px;
        background-size: cover !important;
    }
    
    #myCarousel .carousel-caption {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        width: 80%;
        max-width: 800px;
    }
    
    #myCarousel .carousel-caption h3 {
        font-size: 3.5em;
        font-weight: 700;
        color: white;
        text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        margin-bottom: 20px;
    }
    
    #myCarousel .carousel-caption h3 span {
        color: #2fdab8;
    }
    
    #myCarousel .carousel-caption p {
        font-size: 1.5em;
        color: #f9d806;
        text-shadow: 1px 1px 4px rgba(0,0,0,0.7);
        margin-bottom: 30px;
    }
    
    .sale-w3ls {
        width: 100vw !important;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
    }
    
    .schedule-bottom {
        width: 100vw !important;
        position: relative;
        left: 50%;
        right: 50%;
        margin-left: -50vw;
        margin-right: -50vw;
        background: #2fdab8 !important;
        padding: 60px 0 !important;
    }
    
    .schedule-bottom .container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .agileinfo_schedule_bottom_left {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .agileits_schedule_bottom_right {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .w3ls_schedule_bottom_right_grid h3 {
        color: #333;
        font-size: 1.8em;
        margin-bottom: 20px;
        font-weight: 700;
    }
    
    .w3ls_schedule_bottom_right_grid h3 span {
        color: #e74c3c;
    }
    
    .w3l_schedule_bottom_right_grid1 i {
        font-size: 3em;
        color: #2fdab8;
        margin-bottom: 15px;
    }
    
    .w3l_schedule_bottom_right_grid1 h4 {
        font-size: 0.9em;
        text-transform: uppercase;
        color: #666;
        margin: 10px 0;
        font-weight: 600;
    }
    
    .w3l_schedule_bottom_right_grid1 h5 {
        font-size: 2.5em;
        font-weight: 700;
        color: #333;
    }

    /* Ensure 5 tabs stay on one row */
    #horizontalTab .resp-tabs-list {
        display: flex !important;
        flex-wrap: nowrap !important;
        margin: 0;
        padding: 0;
    }
    #horizontalTab .resp-tabs-list li {
        float: none !important;
        width: 20% !important; /* 5 equal tabs */
        text-align: center;
        box-sizing: border-box;
        white-space: nowrap;
    }

    /* Loading Spinner */
    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px 0;
        width: 100%;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #2fdab8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<!-- Carousel banner -->

<div id="myCarousel" class="carousel slide" data-ride="carousel">
    <ol class="carousel-indicators">
        <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
        <li data-target="#myCarousel" data-slide-to="1"></li>
        <li data-target="#myCarousel" data-slide-to="2"></li>
    </ol>
    <div class="carousel-inner" role="listbox">
        <div class="item active">
            <div class="carousel-caption">
                <h3>Khuyến mãi <span>Đặc biệt</span></h3>
                <p>Sản phẩm hot giảm giá cực sâu</p>
                <a class="hvr-outline-out button2" href="#">Xem ngay</a>
            </div>
        </div>
        <div class="item item2">
            <div class="carousel-caption">
                <h3>Bộ sưu tập <span>Mới</span></h3>
                <p>Phong cách hiện đại, năng động</p>
                <a class="hvr-outline-out button2" href="#">Khám phá</a>
            </div>
        </div>
        <div class="item item3">
            <div class="carousel-caption">
                <h3>Giảm đến <span>50%</span></h3>
                <p>Chỉ trong tuần này</p>
                <a class="hvr-outline-out button2" href="#">Mua ngay</a>
            </div>
        </div>
    </div>

    <a class="left carousel-control" href="#myCarousel" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
    </a>
    <a class="right carousel-control" href="#myCarousel" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
    </a>
</div>

<!-- Tabs sản phẩm -->
<div class="new_arrivals_agile_w3ls_info">
    <div class="container">
        <h3 class="wthree_text_info wow fadeInDown" data-wow-delay="0.1">Sản phẩm <span>mới nhất</span></h3>

        <div id="horizontalTab">
            <ul class="resp-tabs-list">
                <li>Chuột</li>
                <li>Laptop</li>
                <li>Bàn phím</li>
                <li>Âm thanh</li>
                <li>Bags</li>
            </ul>
            <div class="resp-tabs-container">

                <!-- Chuột Tab -->
                <div class="tab1" data-category="chuột">
                    <div class="row">
                        @{
                            var menProducts = Model.Where(p => !string.IsNullOrEmpty(p.Category) && p.Category.ToLower().Contains("chuột")).Take(8).ToList();
                            if (!menProducts.Any())
                            {
                                <div class="col-md-12 text-center" style="padding: 50px 0;">
                                    <p style="font-size: 1.2em; color: #999;">Chưa có sản phẩm trong danh mục này</p>
                                </div>
                            }
                        }
                        @foreach (var product in menProducts)
                        {
                            <div class="col-md-3 product-men wow fadeInUp" data-product-id="@product.Id" data-wow-delay="0.2s" style="margin-bottom: 30px; display: flex;">
                                <div class="men-pro-item simpleCart_shelfItem" style="border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; width: 100%;">
                                    <div class="men-thumb-item" style="position: relative; overflow: hidden; background: #f8f8f8; flex-shrink: 0;">
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-front img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-back img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <div class="men-cart-pro">
                                            <div class="inner-men-cart-pro">
                                                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="link-product-add-cart">Xem chi tiết</a>
                                            </div>
                                        </div>
                                        <span class="product-new-top">New</span>
                                    </div>
                                    <div class="item-info-product text-center" style="padding: 20px 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                            <h4 style="font-size: 1.05em; margin-bottom: 12px; height: 48px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4em;">@product.Name</h4>
                                            <div class="info-product-price" style="margin-bottom: 15px;">
                                                <span class="item_price" style="font-size: 1.3em; font-weight: 700; color: #e74c3c;">@product.Price.ToString("N0") ₫</span>
                                            </div>
                                        </div>
                                        <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-primary hvr-outline-out" style="width: 100%; max-width: 150px; margin: 0 auto;">Chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Laptop Tab -->
                <div class="tab2" data-category="laptop">
                    <div class="row">
                        @{
                            // Hiển thị 8 cái đầu tiên - phần còn lại sẽ được load bởi LoadMoreProducts
                            var laptopProducts = Model.Where(p => !string.IsNullOrEmpty(p.Category) && p.Category.ToLower().Contains("laptop")).Take(8).ToList();
                            if (!laptopProducts.Any())
                            {
                                <div class="col-md-12 text-center" style="padding: 50px 0;">
                                    <p style="font-size: 1.2em; color: #999;">Chưa có sản phẩm trong danh mục này</p>
                                </div>
                            }
                        }
                        @foreach (var product in laptopProducts)
                        {
                            <div class="col-md-3 product-men wow fadeInUp" data-product-id="@product.Id" data-wow-delay="0.2s" style="margin-bottom: 30px; display: flex;">
                                <div class="men-pro-item simpleCart_shelfItem" style="border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; width: 100%;">
                                    <div class="men-thumb-item" style="position: relative; overflow: hidden; background: #f8f8f8; flex-shrink: 0;">
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-front img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-back img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <div class="men-cart-pro">
                                            <div class="inner-men-cart-pro">
                                                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="link-product-add-cart">Xem chi tiết</a>
                                            </div>
                                        </div>
                                        <span class="product-new-top">New</span>
                                    </div>
                                    <div class="item-info-product text-center" style="padding: 20px 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                            <h4 style="font-size: 1.05em; margin-bottom: 12px; height: 48px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4em;">@product.Name</h4>
                                            <div class="info-product-price" style="margin-bottom: 15px;">
                                                <span class="item_price" style="font-size: 1.3em; font-weight: 700; color: #e74c3c;">@product.Price.ToString("N0") ₫</span>
                                            </div>
                                        </div>
                                        <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-primary hvr-outline-out" style="width: 100%; max-width: 150px; margin: 0 auto;">Chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Bàn phím Tab -->
                <div class="tab3" data-category="bàn phím">
                    <div class="row">
                        @{
                            var bagProducts = Model.Where(p => !string.IsNullOrEmpty(p.Category) && (p.Category.ToLower().Contains("bàn phím") || p.Category.ToLower().Contains("ban phim"))).Take(8).ToList();
                            if (!bagProducts.Any())
                            {
                                <div class="col-md-12 text-center" style="padding: 50px 0;">
                                    <p style="font-size: 1.2em; color: #999;">Chưa có sản phẩm trong danh mục này</p>
                                </div>
                            }
                        }
                        @foreach (var product in bagProducts)
                        {
                            <div class="col-md-3 product-men wow fadeInUp" data-product-id="@product.Id" data-wow-delay="0.2s" style="margin-bottom: 30px; display: flex;">
                                <div class="men-pro-item simpleCart_shelfItem" style="border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; width: 100%;">
                                    <div class="men-thumb-item" style="position: relative; overflow: hidden; background: #f8f8f8; flex-shrink: 0;">
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-front img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-back img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <div class="men-cart-pro">
                                            <div class="inner-men-cart-pro">
                                                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="link-product-add-cart">Xem chi tiết</a>
                                            </div>
                                        </div>
                                        <span class="product-new-top">New</span>
                                    </div>
                                    <div class="item-info-product text-center" style="padding: 20px 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                            <h4 style="font-size: 1.05em; margin-bottom: 12px; height: 48px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4em;">@product.Name</h4>
                                            <div class="info-product-price" style="margin-bottom: 15px;">
                                                <span class="item_price" style="font-size: 1.3em; font-weight: 700; color: #e74c3c;">@product.Price.ToString("N0") ₫</span>
                                            </div>
                                        </div>
                                        <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-primary hvr-outline-out" style="width: 100%; max-width: 150px; margin: 0 auto;">Chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Âm thanh Tab -->
                <div class="tab4" data-category="âm thanh">
                    <div class="row">
                        @{
                            var footwearProducts = Model.Where(p => !string.IsNullOrEmpty(p.Category) && (p.Category.ToLower().Contains("âm thanh") || p.Category.ToLower().Contains("am thanh"))).Take(8).ToList();
                            if (!footwearProducts.Any())
                            {
                                <div class="col-md-12 text-center" style="padding: 50px 0;">
                                    <p style="font-size: 1.2em; color: #999;">Chưa có sản phẩm trong danh mục này</p>
                                </div>
                            }
                        }
                        @foreach (var product in footwearProducts)
                        {
                            <div class="col-md-3 product-men wow fadeInUp" data-product-id="@product.Id" data-wow-delay="0.2s" style="margin-bottom: 30px; display: flex;">
                                <div class="men-pro-item simpleCart_shelfItem" style="border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; width: 100%;">
                                    <div class="men-thumb-item" style="position: relative; overflow: hidden; background: #f8f8f8; flex-shrink: 0;">
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-front img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-back img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <div class="men-cart-pro">
                                            <div class="inner-men-cart-pro">
                                                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="link-product-add-cart">Xem chi tiết</a>
                                            </div>
                                        </div>
                                        <span class="product-new-top">New</span>
                                    </div>
                                    <div class="item-info-product text-center" style="padding: 20px 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                            <h4 style="font-size: 1.05em; margin-bottom: 12px; height: 48px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4em;">@product.Name</h4>
                                            <div class="info-product-price" style="margin-bottom: 15px;">
                                                <span class="item_price" style="font-size: 1.3em; font-weight: 700; color: #e74c3c;">@product.Price.ToString("N0") ₫</span>
                                            </div>
                                        </div>
                                        <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-primary hvr-outline-out" style="width: 100%; max-width: 150px; margin: 0 auto;">Chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Bags Tab -->
                <div class="tab5" data-category="bags">
                    <div class="row">
                        @{
                            var bagsProducts = Model.Where(p => !string.IsNullOrEmpty(p.Category) && p.Category.ToLower().Contains("bags")).Take(8).ToList();
                            if (!bagsProducts.Any())
                            {
                                <div class="col-md-12 text-center" style="padding: 50px 0;">
                                    <p style="font-size: 1.2em; color: #999;">Chưa có sản phẩm trong danh mục này</p>
                                </div>
                            }
                        }
                        @foreach (var product in bagsProducts)
                        {
                            <div class="col-md-3 product-men wow fadeInUp" data-product-id="@product.Id" data-wow-delay="0.2s" style="margin-bottom: 30px; display: flex;">
                                <div class="men-pro-item simpleCart_shelfItem" style="border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; width: 100%;">
                                    <div class="men-thumb-item" style="position: relative; overflow: hidden; background: #f8f8f8; flex-shrink: 0;">
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-front img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <img src="@Url.Content(product.ImageUrl)" class="pro-image-back img-responsive" alt="@product.Name" style="width: 100%; height: 250px; object-fit: cover;" />
                                        <div class="men-cart-pro">
                                            <div class="inner-men-cart-pro">
                                                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="link-product-add-cart">Xem chi tiết</a>
                                            </div>
                                        </div>
                                        <span class="product-new-top">New</span>
                                    </div>
                                    <div class="item-info-product text-center" style="padding: 20px 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                                        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                            <h4 style="font-size: 1.05em; margin-bottom: 12px; height: 48px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4em;">@product.Name</h4>
                                            <div class="info-product-price" style="margin-bottom: 15px;">
                                                <span class="item_price" style="font-size: 1.3em; font-weight: 700; color: #e74c3c;">@product.Price.ToString("N0") ₫</span>
                                            </div>
                                        </div>
                                        <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-primary hvr-outline-out" style="width: 100%; max-width: 150px; margin: 0 auto;">Chi tiết</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Sale banner -->
<div class="sale-w3ls">
    <div class="container">
        <h6>Giảm giá <span>40%</span> cho tất cả sản phẩm!</h6>
        <a class="hvr-outline-out button2" href="#">Mua ngay</a>
    </div>
</div>
<!-- Counters -->
<div class="schedule-bottom">
    <div class="container">
        <div class="row">
            <div class="col-md-6 agileinfo_schedule_bottom_left">
                <img src="~/images/mid.jpg" alt="Banner" class="img-responsive" />
            </div>

            <div class="col-md-6 agileits_schedule_bottom_right">
                <div class="w3ls_schedule_bottom_right_grid">
                    <h3>Chúng tôi đã phục vụ hơn <span>5000+</span> khách hàng</h3>
                    <p>Cam kết mang lại sản phẩm chất lượng, giá hợp lý và dịch vụ tận tâm.</p>

                    <div class="row text-center mt-4">
                        <div class="col-md-4 w3l_schedule_bottom_right_grid1 wow fadeInUp" data-wow-delay="0.3s">
                            <i class="fa fa-users" aria-hidden="true"></i>
                            <h4>Khách hàng</h4>
                            <h5 class="counter">5231</h5>
                        </div>

                        <div class="col-md-4 w3l_schedule_bottom_right_grid1 wow fadeInUp" data-wow-delay="0.3s">
                            <i class="fa fa-cubes" aria-hidden="true"></i>
                            <h4>Sản phẩm</h4>
                            <h5 class="counter">@Model.Count()</h5>
                        </div>

                        <div class="col-md-4 w3l_schedule_bottom_right_grid1 wow fadeInUp" data-wow-delay="0.3s">
                            <i class="fa fa-trophy" aria-hidden="true"></i>
                            <h4>Giải thưởng</h4>
                            <h5 class="counter">27</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- //Counters -->




@section Scripts {
    <script src="~/js/jquery.countup.js"></script>
    <script src="~/js/jquery.waypoints.min.js"></script>
    <script>
        // Biến global cho Infinite Scroll
        let isLoading = false;
        let page = 2;
        const pageSize = 8;
        let currentActiveTab = null;
        let sentinelElement = null;
        let observer = null;
        let hasMoreProducts = true;
        let loadedProductIds = new Set();
        
        // Helper: Load từ localStorage
        function getLoadedIdsFromStorage(category) {
            const key = `loaded_${category}`;
            const stored = localStorage.getItem(key);
            return stored ? new Set(JSON.parse(stored)) : new Set();
        }
        
        // Helper: Save vào localStorage
        function saveLoadedIdsToStorage(category, ids) {
            const key = `loaded_${category}`;
            localStorage.setItem(key, JSON.stringify(Array.from(ids)));
        }
        
        // Tạo sentinel element
        function createSentinel() {
            if (currentActiveTab) {
                const oldSentinel = currentActiveTab.querySelector('[data-sentinel="true"]');
                if (oldSentinel) {
                    if (observer) observer.unobserve(oldSentinel);
                    oldSentinel.remove();
                }
                
                sentinelElement = document.createElement('div');
                sentinelElement.setAttribute('data-sentinel', 'true');
                sentinelElement.style.height = '50px';
                
                const rowContainer = currentActiveTab.querySelector('.row');
                console.log('createSentinel - rowContainer found:', !!rowContainer);
                if (rowContainer) {
                    rowContainer.appendChild(sentinelElement);
                    if (observer) {
                        observer.observe(sentinelElement);
                        console.log('Sentinel observed');
                    }
                }
            } else {
                console.warn('createSentinel called but no currentActiveTab');
            }
        }
        
        // Lấy tab active khi chuyển tab
        function updateActiveTab() {
            // First, try finding by visible display style
            let foundTab = null;
            const tabs = document.querySelectorAll('.resp-tabs-container > div[data-category]');
            console.log('updateActiveTab called. Found tabs with data-category:', tabs.length);
            
            for (let tab of tabs) {
                const style = window.getComputedStyle(tab);
                const display = style.display;
                const category = tab.getAttribute('data-category');
                console.log(`Tab: ${category}, display: ${display}, visibility: ${style.visibility}`);
                
                // Check if tab is visible
                if (display !== 'none' && style.visibility !== 'hidden') {
                    foundTab = tab;
                    break;
                }
            }
            
            // If no tab found by display, try first tab as fallback
            if (!foundTab && tabs.length > 0) {
                console.log('No visible tab found, using first tab as fallback');
                foundTab = tabs[0];
            }
            
            if (foundTab) {
                currentActiveTab = foundTab;
                const category = currentActiveTab.getAttribute('data-category');
                page = 2;
                hasMoreProducts = true;
                
                loadedProductIds = getLoadedIdsFromStorage(category);
                console.log(`Active tab: ${category}, loaded products from storage:`, loadedProductIds.size);
                
                createSentinel();
            } else {
                console.warn('No tabs found!');
            }
        }
        
        $(document).ready(function () {
            // Kiểm tra xem đây là lần đầu vào trang hay quay lại từ trang khác
            const isNewSession = !sessionStorage.getItem('home_visited');
            if (isNewSession) {
                localStorage.removeItem('loaded_chuột');
                localStorage.removeItem('loaded_laptop');
                localStorage.removeItem('loaded_bàn phím');
                localStorage.removeItem('loaded_âm thanh');
                localStorage.removeItem('loaded_bags');
                sessionStorage.setItem('home_visited', 'true');
            }
            
            // Tabs
            $('#horizontalTab').easyResponsiveTabs({
                type: 'default',
                width: 'auto',
                fit: true,
                activate: function(event) {
                    // 'this' refers to the clicked tab item (li)
                    const $tab = $(this);
                    const $tabContent = $('#horizontalTab').find('.resp-tab-content-active');
                    
                    console.log('Tab activated:', $tab.text());
                    
                    // Update currentActiveTab directly from the active content
                    if ($tabContent.length > 0) {
                        currentActiveTab = $tabContent[0];
                        const category = currentActiveTab.getAttribute('data-category');
                        console.log('Active category:', category);
                        
                        // Reset state for the new tab
                        page = 2;
                        hasMoreProducts = true;
                        loadedProductIds = getLoadedIdsFromStorage(category);
                        
                        // Create sentinel for infinite scroll
                        createSentinel();
                        
                        // Capture initial products if needed (same logic as before)
                        if (category) {
                            const initialProducts = currentActiveTab.querySelectorAll('[data-product-id]');
                            const initialIds = [];
                            initialProducts.forEach(product => {
                                const id = product.getAttribute('data-product-id');
                                if (id) initialIds.push(id);
                            });
                            
                            // Notify server
                            if (initialIds.length > 0) {
                                $.ajax({
                                    url: '@Url.Action("InitializeLoadedIds", "Home")',
                                    type: 'POST',
                                    data: {
                                        category: category,
                                        productIds: initialIds
                                    },
                                    success: function() {
                                        console.log('Server initialized LoadedIds for:', category);
                                    }
                                });
                            }
                        }
                        
                        // Trigger load if content is short
                        setTimeout(() => {
                             if (!isLoading && hasMoreProducts) {
                                 // Check if we need to load more immediately (e.g. large screen)
                                 const sentinel = currentActiveTab.querySelector('[data-sentinel="true"]');
                                 if (sentinel) {
                                     const rect = sentinel.getBoundingClientRect();
                                     if (rect.top < window.innerHeight + 200) {
                                         loadMoreProducts();
                                     }
                                 }
                             }
                        }, 500);
                    }
                }
            });

            // Counters
            $('.counter').countUp();

            // Scroll-to-top
            $().UItoTop({ easingType: 'easeOutQuart' });

            // Auto-slide main carousel
            $('#myCarousel').carousel({
                interval: 4000,
                pause: "hover"
            });
            
            // Khởi tạo Intersection Observer
            const observerOptions = {
                root: null,
                rootMargin: '200px',
                threshold: 0
            };
            
            observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !isLoading && hasMoreProducts) {
                        loadMoreProducts();
                    }
                });
            }, observerOptions);
            
            // Initial setup
            function loadMoreProducts() {
                console.log('=== loadMoreProducts called ===');
                console.log('State: isLoading=' + isLoading + ', currentActiveTab=' + (!!currentActiveTab) + ', hasMoreProducts=' + hasMoreProducts);
                if (isLoading || !currentActiveTab) {
                    console.log('Returning early: isLoading or no currentActiveTab');
                    return;
                }
                
                const category = currentActiveTab.getAttribute('data-category');
                if (!category) {
                    console.warn('No category found in current tab');
                    return;
                }
                console.log('Category: ' + category + ', Page: ' + page);
                
                const rowContainer = currentActiveTab.querySelector('.row');
                if (!rowContainer) {
                    console.warn('No row container found in current tab');
                    return;
                }
                
                isLoading = true;
                
                // Tạo loading spinner
                const spinnerHTML = `
                    <div class="loading-spinner" data-spinner="true">
                        <div class="spinner"></div>
                    </div>
                `;
                
                const sentinel = rowContainer.querySelector('[data-sentinel="true"]');
                if (sentinel) {
                    sentinel.insertAdjacentHTML('beforebegin', spinnerHTML);
                } else {
                    rowContainer.insertAdjacentHTML('beforeend', spinnerHTML);
                }
                
                // Delay 1.75 giây trước khi gọi API
                setTimeout(() => {
                    $.ajax({
                        url: '@Url.Action("LoadMoreProducts", "Home")',
                        type: 'GET',
                        data: {
                            category: category,
                            page: page,
                            pageSize: pageSize
                        },
                        success: function(html) {
                            console.log('API Success! Response length:', html.length);
                            
                            // Xóa spinner
                            const spinner = rowContainer.querySelector('[data-spinner="true"]');
                            if (spinner) spinner.remove();
                            
                            if (html.trim() === '') {
                                console.log('Empty response - no more products');
                                hasMoreProducts = false; // Set flag khi hết sản phẩm
                                isLoading = false;
                                return;
                            }
                            
                            console.log('Adding products to page...');
                            
                            // Extract product IDs từ HTML (dùng data attribute)
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = html;
                            const newItems = tempDiv.querySelectorAll('[data-product-id]');
                            console.log('Found ' + newItems.length + ' products in response');
                            newItems.forEach(item => {
                                const id = item.getAttribute('data-product-id');
                                if (id) loadedProductIds.add(id);
                            });
                            
                            // Save vào localStorage
                            saveLoadedIdsToStorage(category, loadedProductIds);
                            
                            // Xóa sentinel cũ
                            const oldSentinel = rowContainer.querySelector('[data-sentinel="true"]');
                            if (oldSentinel) {
                                observer.unobserve(oldSentinel);
                                oldSentinel.remove();
                            }
                            
                            // Thêm sản phẩm mới
                            rowContainer.insertAdjacentHTML('beforeend', html);
                            
                            // Tạo sentinel mới
                            const newSentinel = document.createElement('div');
                            newSentinel.setAttribute('data-sentinel', 'true');
                            newSentinel.style.height = '50px';
                            rowContainer.appendChild(newSentinel);
                            observer.observe(newSentinel);
                            
                            page++;
                            isLoading = false;
                        },
                        error: function(err) {
                            const spinner = rowContainer.querySelector('[data-spinner="true"]');
                            if (spinner) spinner.remove();
                            isLoading = false;
                        }
                    });
                }, 1500); // Delay 1.5 giây
            }

            // Initial setup
            setTimeout(() => {
                updateActiveTab();
                
                // Initial load logic for the first tab
                if (currentActiveTab) {
                    const category = currentActiveTab.getAttribute('data-category');
                    if (category) {
                        const initialProducts = currentActiveTab.querySelectorAll('[data-product-id]');
                        const initialIds = [];
                        initialProducts.forEach(product => {
                            const id = product.getAttribute('data-product-id');
                            if (id) {
                                loadedProductIds.add(id);
                                initialIds.push(id);
                            }
                        });
                        
                        if (loadedProductIds.size > 0) {
                            saveLoadedIdsToStorage(category, loadedProductIds);
                            $.ajax({
                                url: '@Url.Action("InitializeLoadedIds", "Home")',
                                type: 'POST',
                                data: { category: category, productIds: initialIds }
                            });
                        }
                    }
                }
            }, 500);
        });
    </script>
}

