@model ShopOnlineCore.Models.Product

@{
    ViewData["Title"] = "Sửa sản phẩm";
}

<style>
    .admin-header {
        background: linear-gradient(135deg, #2fdab8 0%, #27b39e 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
        border-radius: 0;
    }

    .info-card {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }

    .info-card h3 {
        color: #2fdab8;
        font-size: 1.3em;
        font-weight: 700;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .form-group label {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .btn-save {
        background: #27ae60;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-save:hover {
        background: #219150;
        color: white;
    }

    .btn-cancel {
        background: #95a5a6;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
    }

    .btn-cancel:hover {
        background: #7f8c8d;
        color: white;
    }

    .image-selection-item {
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .image-selection-item:hover {
        transform: scale(1.05);
    }

    .image-selection-item input[type="radio"] {
        position: absolute;
        top: 10px;
        left: 10px;
        transform: scale(1.5);
        z-index: 10;
        cursor: pointer;
    }
    
    .image-selection-item.is-main {
        border: 3px solid #2fdab8;
        border-radius: 6px;
    }
</style>

<div class="admin-header">
    <div class="container-fluid" style="padding: 0 10px;">
        <h2 style="margin: 0; font-size: 2em; font-weight: 700;">✏️ Sửa sản phẩm</h2>
        <p style="margin: 5px 0 0 0; opacity: 0.95;">Cập nhật thông tin và hình ảnh sản phẩm</p>
    </div>
</div>

<div class="container-fluid" style="margin-bottom: 50px; padding: 0 10px;">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="info-card">
                <h3><i class="fa fa-edit"></i> Thông tin sản phẩm</h3>
                <form asp-action="Edit" method="post" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="Id" />
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="Name">Tên sản phẩm <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" required />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="CategoryId">Danh mục <span class="text-danger">*</span></label>
                                <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.Categories" required>
                                    <option value="">-- Chọn danh mục --</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="Price">Giá (VND) <span class="text-danger">*</span></label>
                                <input asp-for="Price" type="number" step="1000" min="0" class="form-control" required />
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="Stock">Tồn kho <span class="text-danger">*</span></label>
                                <input asp-for="Stock" type="number" min="0" class="form-control" required />
                                <span asp-validation-for="Stock" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="Description">Mô tả</label>
                        <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <label>Hình ảnh hiện có</label>
                        @if (Model.ImageGallery != null && Model.ImageGallery.Any())
                        {
                            <div class="d-flex flex-wrap gap-3" id="existing-images-container">
                                @for (int i = 0; i < Model.ImageGallery.Count; i++)
                                {
                                    var img = Model.ImageGallery[i];
                                    var isMain = img == Model.ImageUrl;
                                    <div class="image-selection-item @(isMain ? "is-main" : "")" data-image-url="@img">
                                        <input type="radio" name="selectedMainImage" value="@img" @(isMain ? "checked" : "") title="Đặt làm ảnh chính" />
                                        <img src="@Url.Content(img)" alt="Product" style="height: 120px; width: 120px; object-fit: cover;" class="rounded shadow-sm" />
                                        
                                        <button type="button" class="btn btn-danger btn-sm position-absolute" 
                                                style="top: -10px; right: -10px; width: 24px; height: 24px; padding: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center;"
                                                onclick="removeExistingImage(this, '@img')" title="Xóa ảnh này">
                                            <i class="fa fa-times" style="font-size: 12px;"></i>
                                        </button>
                                        <input type="hidden" name="existingImages" value="@img" class="existing-image-input" />
                                    </div>
                                }
                            </div>
                        }
                        else 
                        {
                            <p class="text-muted font-italic">Chưa có ảnh nào.</p>
                        }
                    </div>

                    <div class="form-group mb-3">
                        <label for="files">Thêm ảnh mới</label>
                        <input type="file" name="files" id="files" multiple class="form-control" accept="image/*" />
                        <small class="form-text text-muted">Ảnh mới sẽ được thêm vào thư viện ảnh.</small>
                    </div>

                    <!-- Preview ảnh mới -->
                    <div id="preview" class="d-flex flex-wrap gap-2 mb-4"></div>

                    <div class="form-group text-center">
                        <button type="submit" class="btn btn-save">
                            <i class="fa fa-save"></i> Lưu thay đổi
                        </button>
                        <a asp-action="Index" class="btn btn-cancel">
                            <i class="fa fa-times"></i> Hủy
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Xóa ảnh hiện có
        function removeExistingImage(button, imageUrl) {
            if (!confirm('Bạn có chắc muốn xóa ảnh này?')) return;
            
            const wrapper = button.closest('.image-selection-item');
            wrapper.style.opacity = '0.3';
            wrapper.style.pointerEvents = 'none';
            
            // Disable inputs so they are not sent
            wrapper.querySelector('.existing-image-input').disabled = true;
            wrapper.querySelector('input[type="radio"]').disabled = true;
            
            // Visual removal after delay
            setTimeout(() => {
                wrapper.style.display = 'none';
            }, 300);
        }

        // Highlight main image selection
        document.querySelectorAll('input[name="selectedMainImage"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.image-selection-item').forEach(item => {
                    item.classList.remove('is-main');
                });
                if (this.checked) {
                    this.closest('.image-selection-item').classList.add('is-main');
                }
            });
        });

        // Preview ảnh mới
        document.getElementById('files').addEventListener('change', function (event) {
            const preview = document.getElementById('preview');
            preview.innerHTML = '';
            const files = event.target.files;

            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.style.height = '100px';
                        img.style.width = '100px';
                        img.style.objectFit = 'cover';
                        img.classList.add('rounded', 'border');
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
    </script>
}
