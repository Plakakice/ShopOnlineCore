@model IEnumerable<ShopOnlineCore.Models.Product>
@using System.Globalization
@{
        ViewData["Title"] = "Danh sách sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var culture = CultureInfo.GetCultureInfo("vi-VN");
    decimal sliderMinBound = (decimal?)ViewData["SliderMin"] ?? 0m;
    decimal sliderMaxBound = (decimal?)ViewData["SliderMax"] ?? sliderMinBound;
    decimal filterMinValue = (decimal?)ViewData["FilterMin"] ?? sliderMinBound;
    decimal filterMaxValue = (decimal?)ViewData["FilterMax"] ?? sliderMaxBound;

    if (sliderMaxBound < sliderMinBound)
    {
        sliderMaxBound = sliderMinBound;
    }

    if (filterMinValue < sliderMinBound)
    {
        filterMinValue = sliderMinBound;
    }

    if (filterMaxValue > sliderMaxBound)
    {
        filterMaxValue = sliderMaxBound;
    }

    if (filterMinValue > filterMaxValue)
    {
        var temp = filterMinValue;
        filterMinValue = filterMaxValue;
        filterMaxValue = temp;
    }

    string sliderMinJs = sliderMinBound.ToString(CultureInfo.InvariantCulture);
    string sliderMaxJs = sliderMaxBound.ToString(CultureInfo.InvariantCulture);
    string filterMinJs = filterMinValue.ToString(CultureInfo.InvariantCulture);
    string filterMaxJs = filterMaxValue.ToString(CultureInfo.InvariantCulture);

    string formattedFilterMin = string.Format(culture, "{0:N0}\u20AB", filterMinValue);
    string formattedFilterMax = string.Format(culture, "{0:N0}\u20AB", filterMaxValue);

    var selectedCategoryQuery = ViewData["SelectedCategoryQuery"]?.ToString() ?? string.Empty;
    var selectedSearchQuery = ViewData["SelectedSearchQuery"]?.ToString() ?? string.Empty;

    int currentPage = (int)(ViewData["Page"] ?? 1);
    int pageSize = (int)(ViewData["PageSize"] ?? 9);
    int totalCount = (int)(ViewData["TotalCount"] ?? Model.Count());
    int totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
}

<div class="page-head_agile_info_w3l wow fadeInDown" data-wow-delay="0.1s">
    <div class="container">
        <h3>Sản Phẩm</h3>
        <div class="services-breadcrumb">
            <div class="agile_inner_breadcrumb">
                <ul class="w3_short">
                    <li><a href="@Url.Action("Index", "Home")">Trang chủ</a><i>|</i></li>
                    <li>Sản Phẩm</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Bộ lọc và danh mục -->
<div class="banner-bootom-w3-agileits">
    <div class="container">
        <div class="row">
            <!-- Cột trái -->
            <div class="col-md-3 products-left wow fadeInLeft" data-wow-delay="0.2s">
                <div class="filter-price">
                    <h3><span>Lọc Theo Giá</span></h3>
                    <form method="get" class="price-slider__form" id="price-filter-form">
                        @if (!string.IsNullOrEmpty(selectedCategoryQuery))
                        {
                            <input type="hidden" name="category" value="@selectedCategoryQuery" />
                        }
                        @if (!string.IsNullOrEmpty(selectedSearchQuery))
                        {
                            <input type="hidden" name="search" value="@selectedSearchQuery" />
                        }
                        <input type="hidden" name="minPrice" id="min-price-input" value="@filterMinJs" />
                        <input type="hidden" name="maxPrice" id="max-price-input" value="@filterMaxJs" />

                        <div class="price-slider">
                            <div class="price-slider__track" id="price-slider-track">
                                <input type="range"
                                       id="price-slider-min"
                                       min="@sliderMinJs"
                                       max="@sliderMaxJs"
                                       value="@filterMinJs" />
                                <input type="range"
                                       id="price-slider-max"
                                       min="@sliderMinJs"
                                       max="@sliderMaxJs"
                                       value="@filterMaxJs" />
                            </div>
                            <div class="price-slider__values">
                                <span id="price-min">@formattedFilterMin</span>
                                <span class="price-slider__dash">-</span>
                                <span id="price-max">@formattedFilterMax</span>
                            </div>
                            <button type="submit" class="price-slider__submit">L&#x1ECD;c</button>
                        </div>
                    </form>
                </div>

                <div class="css-treeview">
                    <h4>Danh mục</h4>
                    <ul class="tree-list-pad">
                        <li><a href="@Url.Action("Index")" style="font-weight: 600;"><i class="fa fa-th"></i> Tất cả</a></li>
                        <li><a href="@Url.Action("Index", new { category = "Chuột" })"><i class="fa fa-angle-right"></i> Chuột</a></li>
                        <li><a href="@Url.Action("Index", new { category = "Laptop" })"><i class="fa fa-angle-right"></i> Laptop</a></li>
                        <li><a href="@Url.Action("Index", new { category = "Bàn phím" })"><i class="fa fa-angle-right"></i> Bàn phím</a></li>
                        <li><a href="@Url.Action("Index", new { category = "Bags" })"><i class="fa fa-angle-right"></i> Bags</a></li>
                        <li><a href="@Url.Action("Index", new { category = "Âm thanh" })"><i class="fa fa-angle-right"></i> Âm thanh</a></li>
                    </ul>
                </div>

                <div class="community-poll">
                    <h4>Community Poll</h4>
                    <form>
                        <ul class="tree-list-pad poll-options">
                            <li>
                                <label class="radio">
                                    <input type="radio" name="poll" value="fast-shipping" checked />
                                    <i></i>
                                    Giao hàng nhanh
                                </label>
                            </li>
                            <li>
                                <label class="radio">
                                    <input type="radio" name="poll" value="low-price" />
                                    <i></i>
                                    Giá thấp
                                </label>
                            </li>
                            <li>
                                <label class="radio">
                                    <input type="radio" name="poll" value="high-price" />
                                    <i></i>
                                    Giá cao
                                </label>
                            </li>
                            <li>
                                <label class="radio">
                                    <input type="radio" name="poll" value="long-warranty" />
                                    <i></i>
                                    Bảo hành dài
                                </label>
                            </li>
                        </ul>
                    </form>
                </div>
            </div>

            <!-- Cột phải -->
            <div class="col-md-9 products-right wow fadeInUp" data-wow-delay="0.3s">
                <div class="men-wear-top">
                    <div id="top" class="callbacks_container">
                        <ul class="rslides" id="slider3">
                            <li><img class="img-responsive" src="~/images/banner4.jpg" alt=""/></li>
                            <li><img class="img-responsive" src="~/images/banner3.jpg" alt=""/></li>
                            <li><img class="img-responsive" src="~/images/banner1.jpg" alt=""/></li>
                        </ul>
                    </div>
                </div>

                <div class="clearfix"></div>

                <!-- Thanh thao tác admin -->
                @if (User.IsInRole("Admin"))
                {
                    <div class="mb-3 text-right">
                        <a href="@Url.Action("Create", "Product")" class="btn btn-success">
                            <i class="fa fa-plus"></i> Thêm sản phẩm mới
                        </a>
                    </div>
                }

                <!-- Danh sách sản phẩm -->
                <div class="row">
                    @if (!Model.Any())
                    {
                        <div class="col-md-12 text-center" style="padding: 60px 0;">
                            <i class="fa fa-search" style="font-size: 4em; color: #ccc; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">Không tìm thấy sản phẩm</h3>
                            <p style="color: #999; margin-bottom: 20px;">@(ViewData["SearchTerm"] != null ? $"Không có sản phẩm nào khớp với từ khóa \"{ViewData["SearchTerm"]}\"" : "Không có sản phẩm nào trong danh mục này")</p>
                            <a href="@Url.Action("Index")" class="btn btn-primary">Xem tất cả sản phẩm</a>
                        </div>
                    }
                    @foreach (var product in Model)
                    {
                        <div class="col-md-4 col-sm-6 product-men wow zoomIn" data-wow-delay="0.2s" style="margin-bottom: 30px; display: flex;">
                            <div class="men-pro-item simpleCart_shelfItem" style="border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; width: 100%;">
                                <div class="men-thumb-item" style="position: relative; overflow: hidden; background: #f8f8f8; flex-shrink: 0;">
                                    <img src="@Url.Content(product.ImageUrl)" alt="@product.Name" class="pro-image-front img-responsive" style="width: 100%; height: 250px; object-fit: cover;" />
                                    <img src="@Url.Content(product.ImageUrl)" alt="@product.Name" class="pro-image-back img-responsive" style="width: 100%; height: 250px; object-fit: cover;" />
                                    <div class="men-cart-pro">
                                        <div class="inner-men-cart-pro">
                                            <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="link-product-add-cart">Xem chi tiết</a>
                                        </div>
                                    </div>
                                    <span class="product-new-top">New</span>
                                </div>

                                <div class="item-info-product text-center" style="padding: 20px 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between;">
                                    <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                        <h4 style="font-size: 1.05em; margin-bottom: 12px; height: 48px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4em;">@product.Name</h4>
                                        <div class="info-product-price" style="margin-bottom: 15px;">
                                            <span class="item_price" style="font-size: 1.3em; font-weight: 700; color: #e74c3c;">@product.Price.ToString("N0") ₫</span>
                                        </div>
                                    </div>

                                    <!-- Nút chức năng (chỉ hiển thị cho Admin) -->
                                    @if (User.IsInRole("Admin"))
                                    {
                                        <div class="mt-2" style="display: flex; gap: 8px; justify-content: center;">
                                            <a href="@Url.Action("Edit", "Product", new { id = product.Id })" class="btn btn-warning btn-sm" style="flex: 1; max-width: 100px;"><i class="fa fa-edit"></i></a>
                                            <a href="@Url.Action("Delete", "Product", new { id = product.Id })" class="btn btn-danger btn-sm" onclick="return confirm('Xóa sản phẩm này?');" style="flex: 1; max-width: 100px;"><i class="fa fa-trash"></i></a>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <nav aria-label="Product pagination" class="text-center" style="margin-top:20px;">
                        <ul class="pagination justify-content-center">
                            @{
                                var prevPage = currentPage > 1 ? currentPage - 1 : 1;
                                var nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
                            }
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = prevPage, pageSize = pageSize, category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinValue, maxPrice = filterMaxValue })" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>

                            @for (int i = 1; i <= totalPages; i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { page = i, pageSize = pageSize, category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinValue, maxPrice = filterMaxValue })">@i</a>
                                </li>
                            }

                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = nextPage, pageSize = pageSize, category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinValue, maxPrice = filterMaxValue })" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                        <div class="text-muted" style="margin-top:8px;">
                            Trang @currentPage/@totalPages — @Model.Count() mục, tổng @totalCount sản phẩm
                        </div>
                    </nav>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/responsiveslides.min.js"></script>
    <script src="~/js/jquery.countup.js"></script>
    <script src="~/js/jquery.waypoints.min.js"></script>
    <script src="~/js/wow.min.js"></script>
    <script src="~/js/jquery-ui.js"></script>
    <script>
        new WOW().init();

        $(document).ready(function () {
            // Slider banner
            $("#slider3").responsiveSlides({
                auto: true,
                pager: true,
                nav: false,
                speed: 500,
                namespace: "callbacks"
            });

            const priceForm = document.getElementById("price-filter-form");
            const sliderTrack = document.getElementById("price-slider-track");
            const minRange = document.getElementById("price-slider-min");
            const maxRange = document.getElementById("price-slider-max");
            const minDisplay = document.getElementById("price-min");
            const maxDisplay = document.getElementById("price-max");
            const minHidden = document.getElementById("min-price-input");
            const maxHidden = document.getElementById("max-price-input");

            if (priceForm && sliderTrack && minRange && maxRange && minDisplay && maxDisplay && minHidden && maxHidden) {
                const boundMin = parseFloat(minRange.min);
                const boundMax = parseFloat(minRange.max);
                const difference = boundMax - boundMin;

                let sliderStep = Math.round(difference / 100);
                if (!Number.isFinite(sliderStep) || sliderStep <= 0) {
                    sliderStep = 1;
                }
                if (sliderStep > 1000) {
                    sliderStep = Math.round(sliderStep / 1000) * 1000;
                }
                if (difference > 0 && sliderStep > difference) {
                    sliderStep = Math.max(1, Math.round(difference / 10));
                }

                minRange.step = sliderStep;
                maxRange.step = sliderStep;

                const formatter = new Intl.NumberFormat("vi-VN");

                function setTrack(minValue, maxValue) {
                    if (difference > 0) {
                        const percentMin = ((minValue - boundMin) / difference) * 100;
                        const percentMax = ((maxValue - boundMin) / difference) * 100;
                        sliderTrack.style.background =
                            `linear-gradient(to right, #dcdcdc ${percentMin}%, #2fdab8 ${percentMin}%, #2fdab8 ${percentMax}%, #dcdcdc ${percentMax}%)`;
                    } else {
                        sliderTrack.style.background = "#dcdcdc";
                    }
                }

                function updateOutputs(minValue, maxValue) {
                    minDisplay.textContent = formatter.format(Math.round(minValue)) + "\u20AB";
                    maxDisplay.textContent = formatter.format(Math.round(maxValue)) + "\u20AB";
                    minHidden.value = Math.round(minValue);
                    maxHidden.value = Math.round(maxValue);
                    setTrack(minValue, maxValue);
                }

                function syncFromInputs(changed) {
                    let minValue = parseFloat(minRange.value);
                    let maxValue = parseFloat(maxRange.value);

                    if (difference > 0) {
                        if (changed === "min" && minValue > maxValue - sliderStep) {
                            minValue = Math.max(boundMin, maxValue - sliderStep);
                            minRange.value = minValue;
                        }
                        if (changed === "max" && maxValue < minValue + sliderStep) {
                            maxValue = Math.min(boundMax, minValue + sliderStep);
                            maxRange.value = maxValue;
                        }
                        minValue = Math.max(minValue, boundMin);
                        maxValue = Math.min(maxValue, boundMax);
                    } else {
                        minValue = boundMin;
                        maxValue = boundMax;
                        minRange.value = minValue;
                        maxRange.value = maxValue;
                    }

                    updateOutputs(minValue, maxValue);
                }

                minRange.addEventListener("input", function () { syncFromInputs("min"); });
                maxRange.addEventListener("input", function () { syncFromInputs("max"); });

                syncFromInputs();

                priceForm.addEventListener("submit", function () {
                    syncFromInputs();
                });
            }

            $('.counter').countUp();
        });
    </script>
}


