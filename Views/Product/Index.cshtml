@model IEnumerable<ShopOnlineCore.Models.Product>
@using System.Globalization
@{
        ViewData["Title"] = "Danh sách sản phẩm";
    ViewData["FullWidth"] = true;
    Layout = "~/Views/Shared/_Layout.cshtml";

    var culture = CultureInfo.GetCultureInfo("vi-VN");
    decimal sliderMinBound = (decimal?)ViewData["SliderMin"] ?? 0m;
    decimal sliderMaxBound = (decimal?)ViewData["SliderMax"] ?? sliderMinBound;
    decimal filterMinValue = (decimal?)ViewData["FilterMin"] ?? sliderMinBound;
    decimal filterMaxValue = (decimal?)ViewData["FilterMax"] ?? sliderMaxBound;

    if (sliderMaxBound < sliderMinBound)
    {
        sliderMaxBound = sliderMinBound;
    }

    if (filterMinValue < sliderMinBound)
    {
        filterMinValue = sliderMinBound;
    }

    if (filterMaxValue > sliderMaxBound)
    {
        filterMaxValue = sliderMaxBound;
    }

    if (filterMinValue > filterMaxValue)
    {
        var temp = filterMinValue;
        filterMinValue = filterMaxValue;
        filterMaxValue = temp;
    }

    string sliderMinJs = sliderMinBound.ToString(CultureInfo.InvariantCulture);
    string sliderMaxJs = sliderMaxBound.ToString(CultureInfo.InvariantCulture);
    string filterMinJs = filterMinValue.ToString(CultureInfo.InvariantCulture);
    string filterMaxJs = filterMaxValue.ToString(CultureInfo.InvariantCulture);

    string formattedFilterMin = string.Format(culture, "{0:N0}\u20AB", filterMinValue);
    string formattedFilterMax = string.Format(culture, "{0:N0}\u20AB", filterMaxValue);

    var selectedCategoryQuery = ViewData["SelectedCategoryQuery"]?.ToString() ?? string.Empty;
    var selectedSearchQuery = ViewData["SelectedSearchQuery"]?.ToString() ?? string.Empty;

    int currentPage = (int)(ViewData["Page"] ?? 1);
    int pageSize = (int)(ViewData["PageSize"] ?? 8);
    int totalCount = (int)(ViewData["TotalCount"] ?? Model.Count());
    int totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
}

<style>
/* Sticky sidebar chỉ áp dụng trong trang Product */
@@media (min-width: 992px) {
    .product-sticky-sidebar { position: sticky; top: 300px; align-self: flex-start; }
    .product-sidebar-inner { max-height: calc(100vh - 215px); overflow-y: auto; padding-right: 4px; }
    .product-sidebar-inner::-webkit-scrollbar { width: 8px; }
    .product-sidebar-inner::-webkit-scrollbar-track { background: #f5f5f5; }
    .product-sidebar-inner::-webkit-scrollbar-thumb { background: #d0d0d0; border-radius: 4px; }
    .product-sidebar-inner::-webkit-scrollbar-thumb:hover { background: #b5b5b5; }
}
@@media (max-width: 991.98px) { .product-sticky-sidebar { position: static; } }
</style>

<div class="page-head_agile_info_w3l wow fadeInDown" data-wow-delay="0.1s">
    <div class="container">
        <h3>Sản Phẩm</h3>
        <div class="services-breadcrumb">
            <div class="agile_inner_breadcrumb">
                <ul class="w3_short">
                    <li><a href="@Url.Action("Index", "Home")">Trang chủ</a><i>|</i></li>
                    <li>Sản Phẩm</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Bộ lọc và danh mục -->
<div class="banner-bootom-w3-agileits">
    <div class="container-fluid" style="max-width: 1650px; margin: 0 auto;">
        <div class="row">
            <!-- Cột trái (sidebar lọc) -->
            <div class="col-md-3 products-left wow fadeInLeft product-sticky-sidebar" data-wow-delay="0.2s">
                <div class="product-sidebar-inner">
                <div class="filter-price">
                    <h3><span>Lọc Theo Giá</span></h3>
                    <form method="get" class="price-slider__form" id="price-filter-form">
                        @if (!string.IsNullOrEmpty(selectedCategoryQuery))
                        {
                            <input type="hidden" name="category" value="@selectedCategoryQuery" />
                        }
                        @if (!string.IsNullOrEmpty(selectedSearchQuery))
                        {
                            <input type="hidden" name="search" value="@selectedSearchQuery" />
                        }
                        @if (ViewData["CurrentSort"] != null)
                        {
                            <input type="hidden" name="sort" value="@ViewData["CurrentSort"]" />
                        }
                        <input type="hidden" name="minPrice" id="min-price-input" value="@filterMinJs" />
                        <input type="hidden" name="maxPrice" id="max-price-input" value="@filterMaxJs" />

                        <div class="price-slider">
                            <div class="price-slider__track" id="price-slider-track">
                                <input type="range"
                                       id="price-slider-min"
                                       min="@sliderMinJs"
                                       max="@sliderMaxJs"
                                       value="@filterMinJs" />
                                <input type="range"
                                       id="price-slider-max"
                                       min="@sliderMinJs"
                                       max="@sliderMaxJs"
                                       value="@filterMaxJs" />
                            </div>
                            <div class="price-slider__values">
                                <span id="price-min">@formattedFilterMin</span>
                                <span class="price-slider__dash">-</span>
                                <span id="price-max">@formattedFilterMax</span>
                            </div>
                            <button type="submit" class="price-slider__submit">L&#x1ECD;c</button>
                        </div>
                    </form>
                </div>

                <div class="css-treeview">
                    <h4>Sắp xếp</h4>
                    <ul class="tree-list-pad">
                        <li><a href="@Url.Action("Index", new { sort = "price_asc", category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinJs, maxPrice = filterMaxJs })"><i class="fa fa-sort-amount-asc"></i> Giá: Thấp đến Cao</a></li>
                        <li><a href="@Url.Action("Index", new { sort = "price_desc", category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinJs, maxPrice = filterMaxJs })"><i class="fa fa-sort-amount-desc"></i> Giá: Cao đến Thấp</a></li>
                    </ul>
                </div>

                <div class="css-treeview">
                    <h4>Danh mục</h4>
                    <ul class="tree-list-pad">
                        <li><a href="@Url.Action("Index")" style="font-weight: 600;"><i class="fa fa-th"></i> Tất cả</a></li>
                        @{
                            var categories = ViewBag.Categories as IEnumerable<ShopOnlineCore.Models.Category>;
                        }
                        @if (categories != null)
                        {
                            foreach (var cat in categories)
                            {
                                <li><a href="@Url.Action("Index", new { category = cat.Name })"><i class="fa fa-angle-right"></i> @cat.Name</a></li>
                            }
                        }
                    </ul>
                </div>
                </div><!-- /.product-sidebar-inner -->
            </div>

            <!-- Cột phải -->
            <div class="col-md-9 products-right wow fadeInUp" data-wow-delay="0.3s">
                <!-- Banner slider removed -->

                <div class="clearfix"></div>

                <!-- Thanh thao tác admin -->
                @if (User.IsInRole("Admin"))
                {
                    <div class="mb-3 text-right">
                        <a href="@Url.Action("Create", "Product")" class="btn btn-success">
                            <i class="fa fa-plus"></i> Thêm sản phẩm mới
                        </a>
                    </div>
                }

                <!-- Danh sách sản phẩm -->
                <div class="row">
                    @if (!Model.Any())
                    {
                        <div class="col-md-12 text-center" style="padding: 60px 0;">
                            <i class="fa fa-search" style="font-size: 4em; color: #ccc; margin-bottom: 20px;"></i>
                            <h3 style="color: #666;">Không tìm thấy sản phẩm</h3>
                            <p style="color: #999; margin-bottom: 20px;">@(ViewData["SearchTerm"] != null ? $"Không có sản phẩm nào khớp với từ khóa \"{ViewData["SearchTerm"]}\"" : "Không có sản phẩm nào trong danh mục này")</p>
                            <a href="@Url.Action("Index")" class="btn btn-primary">Xem tất cả sản phẩm</a>
                        </div>
                    }
                    @{ int counter = 0; }
                    @foreach (var product in Model)
                    {
                        counter++;
                        <div class="col-md-3 col-sm-6 product-men wow zoomIn" data-wow-delay="0.2s" style="margin-bottom: 30px; display: flex;">
                            <partial name="_ProductCard" model="product" />
                        </div>
                        if (counter % 4 == 0)
                        {
                            <div class="clearfix visible-md-block visible-lg-block"></div>
                        }
                        if (counter % 2 == 0)
                        {
                            <div class="clearfix visible-sm-block"></div>
                        }
                    }
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <nav aria-label="Product pagination" class="text-center" style="margin-top:20px;">
                        <ul class="pagination justify-content-center">
                            @{
                                var prevPage = currentPage > 1 ? currentPage - 1 : 1;
                                var nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
                            }
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = prevPage, pageSize = pageSize, category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinValue, maxPrice = filterMaxValue })" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>

                            @for (int i = 1; i <= totalPages; i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Index", new { page = i, pageSize = pageSize, category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinValue, maxPrice = filterMaxValue })">@i</a>
                                </li>
                            }

                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = nextPage, pageSize = pageSize, category = selectedCategoryQuery, search = selectedSearchQuery, minPrice = filterMinValue, maxPrice = filterMaxValue })" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                        <div class="text-muted" style="margin-top:8px;">
                            Trang @currentPage/@totalPages — @Model.Count() mục, tổng @totalCount sản phẩm
                        </div>
                    </nav>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/responsiveslides.min.js"></script>
    <script src="~/js/jquery.countup.js"></script>
    <script src="~/js/jquery.waypoints.min.js"></script>
    <script src="~/js/wow.min.js"></script>
    <script src="~/js/jquery-ui.js"></script>
    <script>
        new WOW().init();

        $(document).ready(function () {
            // Slider banner removed


            const priceForm = document.getElementById("price-filter-form");
            const sliderTrack = document.getElementById("price-slider-track");
            const minRange = document.getElementById("price-slider-min");
            const maxRange = document.getElementById("price-slider-max");
            const minDisplay = document.getElementById("price-min");
            const maxDisplay = document.getElementById("price-max");
            const minHidden = document.getElementById("min-price-input");
            const maxHidden = document.getElementById("max-price-input");

            if (priceForm && sliderTrack && minRange && maxRange && minDisplay && maxDisplay && minHidden && maxHidden) {
                const boundMin = parseFloat(minRange.min);
                const boundMax = parseFloat(minRange.max);
                const difference = boundMax - boundMin;

                let sliderStep = Math.round(difference / 100);
                if (!Number.isFinite(sliderStep) || sliderStep <= 0) {
                    sliderStep = 1;
                }
                if (sliderStep > 1000) {
                    sliderStep = Math.round(sliderStep / 1000) * 1000;
                }
                if (difference > 0 && sliderStep > difference) {
                    sliderStep = Math.max(1, Math.round(difference / 10));
                }

                minRange.step = sliderStep;
                maxRange.step = sliderStep;

                const formatter = new Intl.NumberFormat("vi-VN");

                function setTrack(minValue, maxValue) {
                    if (difference > 0) {
                        const percentMin = ((minValue - boundMin) / difference) * 100;
                        const percentMax = ((maxValue - boundMin) / difference) * 100;
                        sliderTrack.style.background =
                            `linear-gradient(to right, #dcdcdc ${percentMin}%, #2fdab8 ${percentMin}%, #2fdab8 ${percentMax}%, #dcdcdc ${percentMax}%)`;
                    } else {
                        sliderTrack.style.background = "#dcdcdc";
                    }
                }

                function updateOutputs(minValue, maxValue) {
                    minDisplay.textContent = formatter.format(Math.round(minValue)) + "\u20AB";
                    maxDisplay.textContent = formatter.format(Math.round(maxValue)) + "\u20AB";
                    minHidden.value = Math.round(minValue);
                    maxHidden.value = Math.round(maxValue);
                    setTrack(minValue, maxValue);
                }

                function syncFromInputs(changed) {
                    let minValue = parseFloat(minRange.value);
                    let maxValue = parseFloat(maxRange.value);

                    if (difference > 0) {
                        if (changed === "min" && minValue > maxValue - sliderStep) {
                            minValue = Math.max(boundMin, maxValue - sliderStep);
                            minRange.value = minValue;
                        }
                        if (changed === "max" && maxValue < minValue + sliderStep) {
                            maxValue = Math.min(boundMax, minValue + sliderStep);
                            maxRange.value = maxValue;
                        }
                        minValue = Math.max(minValue, boundMin);
                        maxValue = Math.min(maxValue, boundMax);

                        // Snap to bounds if close (within 1 step)
                        if (maxValue >= boundMax - sliderStep) {
                            maxValue = boundMax;
                            maxRange.value = boundMax; // Ensure input reflects exact max
                        }
                    } else {
                        minValue = boundMin;
                        maxValue = boundMax;
                        minRange.value = minValue;
                        maxRange.value = maxValue;
                    }

                    updateOutputs(minValue, maxValue);
                }

                minRange.addEventListener("input", function () { syncFromInputs("min"); });
                maxRange.addEventListener("input", function () { syncFromInputs("max"); });

                syncFromInputs();

                priceForm.addEventListener("submit", function () {
                    syncFromInputs();
                });
            }

            $('.counter').countUp();
        });
    </script>
}


